rule win_bazarbackdoor_auto {

    meta:
        author = "Felix Bilstein - yara-signator at cocacoding dot com"
        date = "2021-06-10"
        version = "1"
        description = "Detects win.bazarbackdoor."
        info = "autogenerated rule brought to you by yara-signator"
        tool = "yara-signator v0.6.0"
        signator_config = "callsandjumps;datarefs;binvalue"
        malpedia_reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.bazarbackdoor"
        malpedia_rule_date = "20210604"
        malpedia_hash = "be09d5d71e77373c0f538068be31a2ad4c69cfbd"
        malpedia_version = "20210616"
        malpedia_license = "CC BY-SA 4.0"
        malpedia_sharing = "TLP:WHITE"

    /* DISCLAIMER
     * The strings used in this rule have been automatically selected from the
     * disassembly of memory dumps and unpacked files, using YARA-Signator.
     * The code and documentation is published here:
     * https://github.com/fxb-cocacoding/yara-signator
     * As Malpedia is used as data source, please note that for a given
     * number of families, only single samples are documented.
     * This likely impacts the degree of generalization these rules will offer.
     * Take the described generation method also into consideration when you
     * apply the rules in your use cases and assign them confidence levels.
     */


    strings:
        $sequence_0 = { 488bce 4889442420 ff15???????? 85c0 780a }
            // n = 5, score = 1100
            //   488bce               | dec                 esp
            //   4889442420           | mov                 esi, ecx
            //   ff15????????         |                     
            //   85c0                 | xor                 ebx, ebx
            //   780a                 | dec                 eax

        $sequence_1 = { 498bf0 488bea 4c8bf1 33db }
            // n = 4, score = 1100
            //   498bf0               | dec                 ecx
            //   488bea               | mov                 esi, eax
            //   4c8bf1               | dec                 eax
            //   33db                 | mov                 ebp, edx

        $sequence_2 = { 7507 33c0 e9???????? b8ff000000 }
            // n = 4, score = 1000
            //   7507                 | dec                 eax
            //   33c0                 | mov                 ecx, esi
            //   e9????????           |                     
            //   b8ff000000           | dec                 eax

        $sequence_3 = { 488905???????? 4885c0 750a b82c000000 e9???????? }
            // n = 5, score = 900
            //   488905????????       |                     
            //   4885c0               | dec                 eax
            //   750a                 | mov                 ecx, esi
            //   b82c000000           | dec                 eax
            //   e9????????           |                     

        $sequence_4 = { ffd0 488905???????? 4885c0 7507 }
            // n = 4, score = 900
            //   ffd0                 | js                  0x16
            //   488905????????       |                     
            //   4885c0               | dec                 eax
            //   7507                 | cwde                

        $sequence_5 = { 7406 488b11 ff5210 ff15???????? }
            // n = 4, score = 900
            //   7406                 | mov                 dword ptr [esp + 0x20], eax
            //   488b11               | test                eax, eax
            //   ff5210               | js                  0xe
            //   ff15????????         |                     

        $sequence_6 = { 750a b803000000 e9???????? 660f6f05???????? }
            // n = 4, score = 900
            //   750a                 | mov                 dword ptr [esp + 0x20], eax
            //   b803000000           | test                eax, eax
            //   e9????????           |                     
            //   660f6f05????????     |                     

        $sequence_7 = { ba01000000 33c9 41b8e6b5a12c 448d4a7d e8???????? }
            // n = 5, score = 900
            //   ba01000000           | mov                 eax, 0x100f
            //   33c9                 | dec                 eax
            //   41b8e6b5a12c         | mov                 ecx, esi
            //   448d4a7d             | dec                 eax
            //   e8????????           |                     

        $sequence_8 = { 488d95a0070000 488d442470 41b80f100000 488bce 4889442420 }
            // n = 5, score = 800
            //   488d95a0070000       | movzx               eax, al
            //   488d442470           | push                eax
            //   41b80f100000         | push                eax
            //   488bce               | mov                 eax, edx
            //   4889442420           | sar                 eax, 8

        $sequence_9 = { 4533c9 4889442428 488d95a0070000 488d442470 }
            // n = 4, score = 800
            //   4533c9               | movzx               eax, al
            //   4889442428           | movzx               eax, word ptr [edi]
            //   488d95a0070000       | push                eax
            //   488d442470           | call                ebx

        $sequence_10 = { 0fb70f ff15???????? 0fb74f02 0fb7d8 }
            // n = 4, score = 700
            //   0fb70f               | mov                 dword ptr [esp + 0x20], eax
            //   ff15????????         |                     
            //   0fb74f02             | test                eax, eax
            //   0fb7d8               | js                  0xc

        $sequence_11 = { 0fb74f02 0fb7d8 ff15???????? 0fb74f08 }
            // n = 4, score = 700
            //   0fb74f02             | dec                 eax
            //   0fb7d8               | cwde                
            //   ff15????????         |                     
            //   0fb74f08             | inc                 ecx

        $sequence_12 = { 7512 e8???????? c70016000000 e8???????? ebae }
            // n = 5, score = 600
            //   7512                 | mov                 edx, dword ptr [ecx]
            //   e8????????           |                     
            //   c70016000000         | call                dword ptr [edx + 0x10]
            //   e8????????           |                     
            //   ebae                 | je                  8

        $sequence_13 = { e8???????? 8bf8 85c0 0f84c4010000 }
            // n = 4, score = 600
            //   e8????????           |                     
            //   8bf8                 | cmp                 bx, cx
            //   85c0                 | mov                 eax, dword ptr [ecx + 0x14]
            //   0f84c4010000         | or                  edi, 0xffffffff

        $sequence_14 = { 83e602 e8???????? c70022000000 85db }
            // n = 4, score = 600
            //   83e602               | cmp                 bx, ax
            //   e8????????           |                     
            //   c70022000000         | jb                  0xf9
            //   85db                 | lea                 ecx, dword ptr [eax + 0xa]

        $sequence_15 = { 3c20 7709 84c0 7431 }
            // n = 4, score = 600
            //   3c20                 | test                eax, eax
            //   7709                 | js                  0x16
            //   84c0                 | jne                 9
            //   7431                 | xor                 eax, eax

        $sequence_16 = { e8???????? 83f8ff 0f84ef010000 8b4da7 }
            // n = 4, score = 600
            //   e8????????           |                     
            //   83f8ff               | mov                 dword ptr [eax], 0x16
            //   0f84ef010000         | jmp                 0xffffffb6
            //   8b4da7               | cmp                 bx, ax

        $sequence_17 = { ff15???????? 0fb74f08 440fb7e8 ff15???????? }
            // n = 4, score = 600
            //   ff15????????         |                     
            //   0fb74f08             | je                  8
            //   440fb7e8             | dec                 eax
            //   ff15????????         |                     

        $sequence_18 = { 663bd8 0f822c010000 8d480a 663bd9 72cc }
            // n = 5, score = 600
            //   663bd8               | dec                 eax
            //   0f822c010000         | mov                 edx, dword ptr [ecx]
            //   8d480a               | call                dword ptr [edx + 0x10]
            //   663bd9               | movzx               ecx, word ptr [edi]
            //   72cc                 | movzx               ecx, word ptr [edi + 2]

        $sequence_19 = { c3 0fb74c0818 b80b010000 663bc8 }
            // n = 4, score = 500
            //   c3                   | mov                 eax, dword ptr [esp + 0x88]
            //   0fb74c0818           | dec                 eax
            //   b80b010000           | mov                 eax, dword ptr [eax]
            //   663bc8               | dec                 eax

        $sequence_20 = { 6890010000 686a72995d 6a04 5a }
            // n = 4, score = 400
            //   6890010000           | jne                 0x3f
            //   686a72995d           | xor                 eax, eax
            //   6a04                 | mov                 eax, 0xff
            //   5a                   | je                  0x47

        $sequence_21 = { 75ef 8bd6 33c9 8a440c68 }
            // n = 4, score = 400
            //   75ef                 | dec                 eax
            //   8bd6                 | test                ecx, ecx
            //   33c9                 | je                  0x52
            //   8a440c68             | dec                 eax

        $sequence_22 = { ff15???????? 33c9 0fb7c0 41 663bf1 }
            // n = 5, score = 400
            //   ff15????????         |                     
            //   33c9                 | dec                 eax
            //   0fb7c0               | mov                 dword ptr [esp + 0x20], eax
            //   41                   | test                eax, eax
            //   663bf1               | js                  0x40

        $sequence_23 = { 50 0fb745ea 50 0fb745e8 50 68???????? e8???????? }
            // n = 7, score = 400
            //   50                   | mov                 eax, 0x100f
            //   0fb745ea             | dec                 eax
            //   50                   | mov                 ecx, esi
            //   0fb745e8             | dec                 eax
            //   50                   | mov                 dword ptr [esp + 0x20], eax
            //   68????????           |                     
            //   e8????????           |                     

        $sequence_24 = { 03d0 eb05 88443c10 47 }
            // n = 4, score = 400
            //   03d0                 | js                  0x2c
            //   eb05                 | dec                 eax
            //   88443c10             | cwde                
            //   47                   | inc                 ecx

        $sequence_25 = { a3???????? 85c0 7507 6a38 }
            // n = 4, score = 400
            //   a3????????           |                     
            //   85c0                 | mov                 eax, 0x100f
            //   7507                 | dec                 eax
            //   6a38                 | mov                 ecx, esi

        $sequence_26 = { 6866f3a52c 42 e8???????? 59 }
            // n = 4, score = 400
            //   6866f3a52c           | dec                 eax
            //   42                   | mov                 edx, dword ptr [ecx]
            //   e8????????           |                     
            //   59                   | call                dword ptr [edx + 0x10]

        $sequence_27 = { 53 6a02 ff15???????? 83f801 }
            // n = 4, score = 300
            //   53                   | dec                 eax
            //   6a02                 | mov                 dword ptr [esp + 0x20], eax
            //   ff15????????         |                     
            //   83f801               | test                eax, eax

        $sequence_28 = { 33d2 83c40c 8d4a01 3bf9 }
            // n = 4, score = 300
            //   33d2                 | test                eax, eax
            //   83c40c               | js                  0xc
            //   8d4a01               | inc                 ecx
            //   3bf9                 | mov                 eax, 0x100f

        $sequence_29 = { 6a04 68???????? ff15???????? 8bf8 83ffff }
            // n = 5, score = 300
            //   6a04                 | dec                 eax
            //   68????????           |                     
            //   ff15????????         |                     
            //   8bf8                 | test                eax, eax
            //   83ffff               | je                  9

        $sequence_30 = { 0fb6c1 50 8bc2 c1f808 0fb6c0 }
            // n = 5, score = 300
            //   0fb6c1               | mov                 ecx, 0xbb8
            //   50                   | call                eax
            //   8bc2                 | dec                 ecx
            //   c1f808               | mov                 esi, eax
            //   0fb6c0               | dec                 eax

        $sequence_31 = { 83c410 b800308804 6a00 50 6a00 6a00 }
            // n = 6, score = 300
            //   83c410               | dec                 eax
            //   b800308804           | mov                 dword ptr [esp + 0x20], eax
            //   6a00                 | test                eax, eax
            //   50                   | js                  0x13
            //   6a00                 | inc                 ecx
            //   6a00                 | mov                 eax, 0x100f

        $sequence_32 = { 733c 8a02 3cc0 721e 0fb6c8 0fb64201 }
            // n = 6, score = 300
            //   733c                 | dec                 eax
            //   8a02                 | mov                 ecx, esi
            //   3cc0                 | dec                 eax
            //   721e                 | mov                 dword ptr [esp + 0x20], eax
            //   0fb6c8               | dec                 eax
            //   0fb64201             | mov                 ecx, esi

        $sequence_33 = { 745c 57 8d450c 50 ff7508 }
            // n = 5, score = 300
            //   745c                 | dec                 eax
            //   57                   | mov                 ecx, esi
            //   8d450c               | dec                 eax
            //   50                   | mov                 dword ptr [esp + 0x20], eax
            //   ff7508               | test                eax, eax

        $sequence_34 = { 53 8bd8 8d4b01 51 }
            // n = 4, score = 300
            //   53                   | je                  8
            //   8bd8                 | dec                 eax
            //   8d4b01               | mov                 edx, dword ptr [ecx]
            //   51                   | call                dword ptr [edx + 0x10]

        $sequence_35 = { 0f94c0 833d????????0a 0f9cc1 84c1 7543 30c1 0f849b000000 }
            // n = 7, score = 200
            //   0f94c0               | xor                 ecx, ecx
            //   833d????????0a       |                     
            //   0f9cc1               | dec                 eax
            //   84c1                 | mov                 dword ptr [esp + 0x28], eax
            //   7543                 | dec                 eax
            //   30c1                 | lea                 edx, dword ptr [ebp + 0x7a0]
            //   0f849b000000         | dec                 eax

        $sequence_36 = { 4c8d742430 49c70600000000 4c8d44242c 41c70000000000 4c89f2 4531c9 e8???????? }
            // n = 7, score = 200
            //   4c8d742430           | mov                 dword ptr [esp + 0x28], eax
            //   49c70600000000       | dec                 eax
            //   4c8d44242c           | lea                 edx, dword ptr [ebp + 0x7a0]
            //   41c70000000000       | dec                 eax
            //   4c89f2               | lea                 eax, dword ptr [esp + 0x70]
            //   4531c9               | inc                 ecx
            //   e8????????           |                     

        $sequence_37 = { 85d1 0f94c1 833d????????0a 0f9cc2 84ca 7526 30ca }
            // n = 7, score = 200
            //   85d1                 | dec                 eax
            //   0f94c1               | add                 eax, 0x28
            //   833d????????0a       |                     
            //   0f9cc2               | dec                 eax
            //   84ca                 | mov                 dword ptr [esp + 0x28], eax
            //   7526                 | dec                 eax
            //   30ca                 | mov                 eax, dword ptr [esp + 0x70]

        $sequence_38 = { ba01000000 41b8c613c449 41b999000000 e8???????? 4889f9 31d2 4989f0 }
            // n = 7, score = 200
            //   ba01000000           | lea                 eax, dword ptr [esp + 0x70]
            //   41b8c613c449         | inc                 ecx
            //   41b999000000         | mov                 eax, 0x100f
            //   e8????????           |                     
            //   4889f9               | inc                 ebp
            //   31d2                 | xor                 ecx, ecx
            //   4989f0               | dec                 eax

        $sequence_39 = { 0f8407020000 41807c240100 0f8596000000 c644246800 8b05???????? 8d48ff }
            // n = 6, score = 200
            //   0f8407020000         | dec                 eax
            //   41807c240100         | mov                 eax, dword ptr [eax]
            //   0f8596000000         | test                eax, eax
            //   c644246800           | jne                 0xb
            //   8b05????????         |                     
            //   8d48ff               | xor                 eax, eax

        $sequence_40 = { 41b8ff000000 31d2 e8???????? 8b05???????? 8d48ff 0fafc8 89c8 }
            // n = 7, score = 200
            //   41b8ff000000         | mov                 eax, 0x100f
            //   31d2                 | dec                 eax
            //   e8????????           |                     
            //   8b05????????         |                     
            //   8d48ff               | mov                 ecx, esi
            //   0fafc8               | dec                 eax
            //   89c8                 | lea                 edx, dword ptr [ebp + 0x590]

        $sequence_41 = { 0f9cc0 83fa09 0f9fc2 38d8 0f85bdf6ffff 08ca 80f201 }
            // n = 7, score = 200
            //   0f9cc0               | dec                 eax
            //   83fa09               | mov                 ecx, esi
            //   0f9fc2               | test                eax, eax
            //   38d8                 | inc                 eax
            //   0f85bdf6ffff         | mov                 dword ptr [esp + 0x20], eax
            //   08ca                 | dec                 eax
            //   80f201               | mov                 eax, dword ptr [esp + 0x28]

        $sequence_42 = { 8d69ff 0fafe9 b9ffffffff 31cd 83cdfe 39cd 0f94c3 }
            // n = 7, score = 200
            //   8d69ff               | dec                 eax
            //   0fafe9               | mov                 eax, dword ptr [esp + 0x58]
            //   b9ffffffff           | dec                 eax
            //   31cd                 | arpl                word ptr [eax + 0x3c], ax
            //   83cdfe               | mov                 dword ptr [esp + 0x20], 0
            //   39cd                 | dec                 eax
            //   0f94c3               | mov                 eax, dword ptr [esp + 0x88]

        $sequence_43 = { 488b442430 488b4c2440 48894808 488b442438 0fb74016 2500200000 85c0 }
            // n = 7, score = 100
            //   488b442430           | test                edx, edx
            //   488b4c2440           | dec                 ecx
            //   48894808             | mov                 esi, eax
            //   488b442438           | dec                 eax
            //   0fb74016             | mov                 ebp, edx
            //   2500200000           | dec                 esp
            //   85c0                 | mov                 esi, ecx

        $sequence_44 = { 488b4c2438 4803c8 488bc1 4889442430 488b0424 }
            // n = 5, score = 100
            //   488b4c2438           | dec                 eax
            //   4803c8               | test                eax, eax
            //   488bc1               | je                  0x44
            //   4889442430           | dec                 eax
            //   488b0424             | arpl                word ptr [eax + 4], dx

        $sequence_45 = { 4889442428 488b842488000000 488b00 48b900000000ffffffff 488b4030 4823c1 4889442440 }
            // n = 7, score = 100
            //   4889442428           | mov                 ecx, esi
            //   488b842488000000     | dec                 eax
            //   488b00               | mov                 dword ptr [esp + 0x20], eax
            //   48b900000000ffffffff     | test    eax, eax
            //   488b4030             | js                  0x16
            //   4823c1               | inc                 ecx
            //   4889442440           | mov                 eax, 0x100f

        $sequence_46 = { 0fb600 488b4c2410 0fb609 3bc1 7e0a }
            // n = 5, score = 100
            //   0fb600               | cwde                
            //   488b4c2410           | je                  8
            //   0fb609               | dec                 eax
            //   3bc1                 | mov                 edx, dword ptr [ecx]
            //   7e0a                 | call                dword ptr [edx + 0x10]

        $sequence_47 = { 488b4c2458 f77150 8bc2 85c0 751e 488b442460 8b4010 }
            // n = 7, score = 100
            //   488b4c2458           | dec                 eax
            //   f77150               | mov                 ecx, esi
            //   8bc2                 | dec                 eax
            //   85c0                 | mov                 dword ptr [esp + 0x20], eax
            //   751e                 | test                eax, eax
            //   488b442460           | js                  0x16
            //   8b4010               | dec                 eax

        $sequence_48 = { 4889442430 48837c243000 7504 33c0 eb59 488b442428 }
            // n = 6, score = 100
            //   4889442430           | dec                 eax
            //   48837c243000         | test                ecx, ecx
            //   7504                 | je                  8
            //   33c0                 | dec                 eax
            //   eb59                 | mov                 edx, dword ptr [ecx]
            //   488b442428           | call                dword ptr [edx + 0x10]

        $sequence_49 = { ff15???????? c744242000000000 e9???????? 488b842488000000 488b4c2458 48894810 488b842488000000 }
            // n = 7, score = 100
            //   ff15????????         |                     
            //   c744242000000000     | dec                 eax
            //   e9????????           |                     
            //   488b842488000000     | cwde                
            //   488b4c2458           | inc                 ecx
            //   48894810             | mov                 eax, 0x100f
            //   488b842488000000     | dec                 eax

        $sequence_50 = { ffc0 89442420 488b442428 4883c028 4889442428 488b442470 488b00 }
            // n = 7, score = 100
            //   ffc0                 | dec                 eax
            //   89442420             | cwde                
            //   488b442428           | dec                 eax
            //   4883c028             | mov                 dword ptr [esp + 0x20], eax
            //   4889442428           | test                eax, eax
            //   488b442470           | js                  0xc
            //   488b00               | dec                 eax

    condition:
        7 of them and filesize < 507904
}
